<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Hiring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/public/js/auth-utils.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="antialiased bg-gray-100" style="font-family: 'Inter', sans-serif;">
    <div id="navbar-root"></div>

    <div class="min-h-[calc(100vh-4rem)] p-4">
        <div class="max-w-6xl mx-auto">
            <!-- Step 1: Process Selection -->
            <div id="process-selection" class="">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Apply for Jobs</h1>
                    <p class="text-gray-600 mt-2">Browse available positions and apply with your resume.</p>
                </div>
                
                <!-- Loading State -->
                <div id="loading-processes" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-4 text-gray-600">Loading available positions...</p>
                </div>
                
                <!-- Processes List -->
                <div id="processes-container" class="hidden space-y-4">
                    <!-- Processes will be populated here -->
                </div>
            </div>
            
            <!-- Step 2: Resume Upload -->
            <div id="resume-upload-section" class="hidden">
                <div class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl">
                    <div class="mb-6">
                        <button onclick="goBackToProcesses()" class="text-blue-600 hover:text-blue-800 mb-4">
                            ‚Üê Back to Job Listings
                        </button>
                        <h2 class="text-2xl font-bold text-gray-900">Submit Your Application</h2>
                        <p class="text-gray-600 mt-2">Upload your resume for the selected position.</p>
                    </div>
                    
                    <!-- Selected Process Info -->
                    <div id="selected-process-info" class="bg-blue-50 p-4 rounded-lg mb-6">
                        <!-- Process info will be populated here -->
                    </div>
                    
                    <form id="resumeForm" class="space-y-6">
                        <div>
                            <label for="resume-upload" class="text-sm font-medium text-gray-700">Upload Resume (PDF/TXT/DOCX)</label>
                            <input type="file" id="resume-upload" required accept=".pdf,.txt,.docx"
                                class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                        </div>
                        <button type="submit"
                            class="w-full py-3 px-4 rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Submit Application</button>
                        <div id="resume-message" class="text-center text-sm mt-2"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/public/js/navbar.js"></script>
    <script>
        const API_BASE = '';
        let selectedProcess = null;
        let candidateData = null;

        // Format date with IST time in 12-hour format
        function formatDate(dateString) {
            if (!dateString) return 'Not specified';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } catch (e) {
                return 'Invalid date';
            }
        }

        // Create process card
        function createProcessCard(process) {
            const now = new Date();
            const deadline = new Date(process.resume_deadline);
            const isExpired = deadline < now;
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow ${
                    isExpired ? 'opacity-60' : ''
                }">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">${process.process_name || 'Unnamed Process'}</h3>
                            <p class="text-gray-600 mb-2">${process.job_title || 'No job title specified'}</p>
                            <p class="text-sm text-gray-500">Department: ${process.department || 'Not specified'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500 mb-2">Application Deadline</div>
                            <div class="text-sm font-medium ${isExpired ? 'text-red-600' : 'text-green-600'}">
                                ${formatDate(process.resume_deadline)}
                            </div>
                            ${isExpired ? '<div class="text-xs text-red-500 mt-1">Expired</div>' : ''}
                        </div>
                    </div>
                    
                    ${process.job_description ? `
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Job Description</h4>
                            <p class="text-sm text-gray-600 line-clamp-3">${process.job_description}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <div class="text-xs text-gray-500">
                            Process ID: ${process._id}
                        </div>
                        <button 
                            onclick="selectProcess('${process._id}')" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors ${
                                isExpired ? 'opacity-50 cursor-not-allowed' : ''
                            }" 
                            ${isExpired ? 'disabled' : ''}
                        >
                            ${isExpired ? 'Application Closed' : 'Apply Now'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Load and display processes
        async function loadProcesses() {
            try {
                document.getElementById('loading-processes').classList.remove('hidden');
                document.getElementById('processes-container').classList.add('hidden');
                
                const res = await fetch(`${API_BASE}/processes`);
                const processes = await res.json();
                
                const container = document.getElementById('processes-container');
                container.innerHTML = processes.map(createProcessCard).join('');
                
                document.getElementById('loading-processes').classList.add('hidden');
                document.getElementById('processes-container').classList.remove('hidden');
                
            } catch (e) {
                console.error('Failed to load processes:', e);
                document.getElementById('loading-processes').innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-600">Failed to load job listings. Please try again.</p>
                        <button onclick="loadProcesses()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Get candidate data from database
        async function getCandidateData() {
            try {
                const candidateId = window.AuthUtils.getStoredCandidateId();
                if (!candidateId) return null;
                
                const response = await window.AuthUtils.authenticatedFetch(`${API_BASE}/${candidateId}/me`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (e) {
                console.error('Failed to get candidate data:', e);
            }
            return null;
        }

        // Select process and show resume upload
        async function selectProcess(processId) {
            try {
                const res = await fetch(`${API_BASE}/processes/${processId}`);
                selectedProcess = await res.json();
                
                // Update URL to include process ID
                const newUrl = `${window.location.pathname}?process=${processId}`;
                window.history.pushState({processId}, '', newUrl);
                
                // Get candidate data
                candidateData = await getCandidateData();
                
                console.log('DEBUG: Selected process data:', selectedProcess);
                
                // Show selected process info
                document.getElementById('selected-process-info').innerHTML = `
                    <h3 class="font-semibold text-gray-900">${selectedProcess.process.process_name}</h3>
                    <p class="text-sm text-gray-600 mt-1">${selectedProcess.process.job_title || 'No job title'}</p>
                    <p class="text-xs text-gray-500 mt-2">Deadline: ${formatDate(selectedProcess.process.resume_deadline)}</p>
                `;
                
                // Switch to upload section
                document.getElementById('process-selection').classList.add('hidden');
                document.getElementById('resume-upload-section').classList.remove('hidden');
                
            } catch (e) {
                alert('Failed to load process details. Please try again.');
            }
        }

        // Go back to process selection
        function goBackToProcesses() {
            document.getElementById('process-selection').classList.remove('hidden');
            document.getElementById('resume-upload-section').classList.add('hidden');
            selectedProcess = null;
            
            // Remove process ID from URL
            const newUrl = window.location.pathname;
            window.history.pushState({}, '', newUrl);
        }

        // Handle resume form submission
        document.getElementById('resumeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedProcess || !candidateData) {
                document.getElementById('resume-message').textContent = 'Missing process or candidate data.';
                return;
            }
            
            const resumeFile = document.getElementById('resume-upload').files[0];
            const messageEl = document.getElementById('resume-message');
            
            if (!resumeFile) {
                messageEl.textContent = 'Please upload a resume file.';
                return;
            }
            
            messageEl.textContent = 'Submitting application...';
            
            try {
                const candidateId = window.AuthUtils.getStoredCandidateId();
                
                // Upload resume file
                const formData = new FormData();
                formData.append('name', candidateData.name || '');
                formData.append('file', resumeFile);
                formData.append('process_id', selectedProcess.process._id);
                console.log('DEBUG: selectedProcess:', selectedProcess);
                console.log('DEBUG: Sending process_id:', selectedProcess.process._id);
                
                const uploadResp = await window.AuthUtils.authenticatedFetch(`${API_BASE}/${candidateId}/upload-resume`, {
                    method: 'POST',
                    body: formData
                });
                    
                if (!uploadResp.ok) {
                    const er = await uploadResp.json().catch(() => ({}));
                    messageEl.textContent = `Upload error: ${er.detail || uploadResp.statusText}`;
                    return;
                }
                
                // Submit application
                const response = await window.AuthUtils.authenticatedFetch(`${API_BASE}/${candidateId}/submit-resume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        name: candidateData.name, 
                        email: candidateData.email, 
                        process_id: selectedProcess.process._id 
                    })
                });
                    
                const result = await response.json();
                
                if (response.ok) {
                    messageEl.textContent = 'Application submitted successfully!';
                    messageEl.className = 'text-center text-sm mt-2 text-green-600';
                    
                    // Reset and go back after delay
                    setTimeout(() => {
                        document.getElementById('resumeForm').reset();
                        goBackToProcesses();
                        messageEl.className = 'text-center text-sm mt-2';
                        messageEl.textContent = '';
                    }, 2000);
                } else {
                    messageEl.textContent = `Error: ${result.detail || 'Failed to submit'}`;
                    messageEl.className = 'text-center text-sm mt-2 text-red-600';
                }
                
            } catch (error) {
                messageEl.textContent = `An error occurred: ${error.message}`;
                messageEl.className = 'text-center text-sm mt-2 text-red-600';
            }
        });

        // Check URL for process ID on page load
        function checkUrlForProcess() {
            const urlParams = new URLSearchParams(window.location.search);
            const processId = urlParams.get('process');
            if (processId) {
                selectProcess(processId);
            }
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.processId) {
                selectProcess(event.state.processId);
            } else {
                goBackToProcesses();
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            if (window.AuthUtils && !window.AuthUtils.initAuthCheck()) {
                return;
            }
            loadProcesses().then(() => {
                checkUrlForProcess();
            });
        });
    </script>
</body>

</html>